<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Underdog Slugging Association</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- =========================
       LOGIN PANEL (shows when logged out)
       ========================= -->
  <section id="loginPanel" class="panel loginPanel">
    <div class="panelHeader">
      <h2>USA Login</h2>
      <div class="panelNote">Email is only for signing in. Your username is what everyone sees.</div>
    </div>

    <div class="loginGrid">
      <input class="input" id="email" placeholder="Email" type="email" />
      <input class="input" id="password" placeholder="Password" type="password" />
      <input class="input" id="username" placeholder="Username (only for sign up)" />
    </div>

    <div class="loginActions">
      <button class="primaryBtn" id="signupBtn" type="button">Create Account</button>
      <button class="ghostBtn" id="loginBtn" type="button">Login</button>
    </div>

    <div class="smallNote" id="authError"></div>
  </section>


  <!-- =========================
       MAIN APP (shows when logged in)
       ========================= -->
  <div id="appRoot" class="hidden">
    <div class="pageOverlay">

      <!-- HUD -->
      <header class="hud">
        <div class="hudLeft">
          <img class="hudLogo" src="./assets/logos/league/usa-logo.PNG" alt="League Logo" />
          <div class="hudTitleBlock">
            <div class="hudTitle">Underdog Slugging Association</div>
            <div class="hudSub">Season: <span id="hudSeason">Season 1</span></div>
          </div>
        </div>

        <div class="hudRight">
          <div class="hudStat">
            <div class="hudLabel">User</div>
            <div class="hudValue" id="hudUsername">...</div>
          </div>

          <div class="hudStat hudCoins">
            <img class="coinIcon" src="./assets/icons/waffle-coin.PNG" alt="Waffle Coin" />
            <div>
              <div class="hudLabel">Waffle Coins</div>
              <div class="hudValue" id="hudCoins">0</div>
            </div>
          </div>

          <div class="hudStat">
            <div class="hudLabel">Voting %</div>
            <div class="hudValue" id="hudVotePct">0%</div>
          </div>

          <div class="hudStat">
            <div class="hudLabel">Total Votes</div>
            <div class="hudValue" id="hudVoteCount">0</div>
          </div>

          <button class="ghostBtn hudLogout" id="logoutBtn" type="button">Logout</button>
        </div>
      </header>


      <!-- MAIN GRID -->
      <main class="grid">

        <!-- STANDINGS -->
        <section class="panel">
          <div class="panelHeader">
            <h2>Standings</h2>
            <div class="tabs">
              <button class="tabBtn active" data-tabgroup="standings" data-tab="league" type="button">League</button>
              <button class="tabBtn" data-tabgroup="standings" data-tab="solar" type="button">Solar</button>
              <button class="tabBtn" data-tabgroup="standings" data-tab="lunar" type="button">Lunar</button>
            </div>
          </div>

          <div class="tabContent active" data-tabgroup="standings" data-tab="league">
            <div id="standingsLeague"></div>
          </div>

          <div class="tabContent" data-tabgroup="standings" data-tab="solar">
            <div class="confHeader">
              <img class="confLogo" src="./assets/logos/conferences/solar.png" alt="Solar" />
              <div class="confTitle">Solar Conference</div>
            </div>
            <div id="standingsSolar"></div>
          </div>

          <div class="tabContent" data-tabgroup="standings" data-tab="lunar">
            <div class="confHeader">
              <img class="confLogo" src="./assets/logos/conferences/lunar.png" alt="Lunar" />
              <div class="confTitle">Lunar Conference</div>
            </div>
            <div id="standingsLunar"></div>
          </div>
        </section>


        <!-- VOTING + SHOP + COLLECTION -->
        <section class="panel">
          <div class="panelHeader">
            <h2>Voting & Shops</h2>
            <div class="tabs">
              <button class="tabBtn active" data-tabgroup="right" data-tab="voting" type="button">Voting</button>
              <button class="tabBtn" data-tabgroup="right" data-tab="giftshop" type="button">Mask‚Äôs Gift Shop</button>
              <button class="tabBtn" data-tabgroup="right" data-tab="collection" type="button">Collection</button>
            </div>
          </div>

          <div class="tabContent active" data-tabgroup="right" data-tab="voting">
            <div class="panelNote" id="votingMeta">Next game day: loading...</div>
            <div id="votingList"></div>
            <button class="primaryBtn" id="submitVotesBtn" type="button">Submit Votes</button>
            <div class="smallNote" id="voteLockNote"></div>
          </div>

          <div class="tabContent" data-tabgroup="right" data-tab="giftshop">
            <div class="smallNote">Click an item to view it bigger and buy it.</div>
            <div id="giftShopInline"></div>
          </div>

          <div class="tabContent" data-tabgroup="right" data-tab="collection">
            <div class="smallNote">Click an item to view it bigger.</div>
            <div id="collectionInline"></div>
          </div>
        </section>


        <!-- LEAGUE LEADERS -->
        <section class="panel">
          <div class="panelHeader">
            <h2>League Leaders</h2>
            <div class="tabs">
              <button class="tabBtn active" data-tabgroup="leaders" data-tab="hr" type="button">HR</button>
              <button class="tabBtn" data-tabgroup="leaders" data-tab="runs" type="button">Runs</button>
              <button class="tabBtn" data-tabgroup="leaders" data-tab="rbi" type="button">RBI</button>
              <button class="tabBtn" data-tabgroup="leaders" data-tab="so" type="button">SO</button>
            </div>
          </div>
          <div id="leadersContent"></div>
        </section>


        <!-- SLOTS ONLY (Prediction Leaders removed) -->
        <section class="panel">
          <div class="panelHeader">
            <h2>Ploopy‚Äôs Slick Slots</h2>
            <div class="tabs">
              <button class="tabBtn active" data-tabgroup="fun" data-tab="slots" type="button">Play</button>
            </div>
          </div>

          <div class="tabContent active" data-tabgroup="fun" data-tab="slots">
            <div id="slotsInline"></div>
          </div>
        </section>


        <!-- GAME LOGS + SUGGESTIONS -->
        <section class="panel">
          <div class="panelHeader">
            <h2>Season & Suggestions</h2>
            <div class="tabs">
              <button class="tabBtn active" data-tabgroup="season" data-tab="logs" type="button">Season 1 Game Logs</button>
              <button class="tabBtn" data-tabgroup="season" data-tab="suggest" type="button">Future Season Suggestions</button>
            </div>
          </div>

          <div class="tabContent active" data-tabgroup="season" data-tab="logs">
            <div id="gameLogs"></div>
          </div>

          <div class="tabContent" data-tabgroup="season" data-tab="suggest">
            <textarea id="suggestionText" class="textArea" placeholder="Buff/Nerf suggestions... (1 per day)"></textarea>
            <button class="primaryBtn" id="submitSuggestionBtn" type="button">Submit Suggestion</button>
            <div class="smallNote" id="suggestionNote"></div>
          </div>
        </section>

      </main>


      <!-- ESPN style ticker -->
      <div class="ticker" id="ticker">
        <div class="tickerInner" id="tickerInner"></div>
      </div>

      <!-- Expanded headlines drawer -->
      <div class="tickerDrawer hidden" id="tickerDrawer">
        <div class="drawerHeader">
          <div class="drawerTitle">Headlines</div>
          <button class="ghostBtn" id="closeDrawerBtn" type="button">Close</button>
        </div>
        <div id="headlineList"></div>
      </div>

    </div>
  </div>


  <!-- REWARD POPUP (reused for daily bonus + results) -->
  <div class="modal hidden" id="rewardModal">
    <div class="modalCard">
      <h3 id="rewardTitle">Rewards</h3>
      <div id="rewardText"></div>
      <button class="primaryBtn" id="rewardCloseBtn" type="button">Nice!</button>
    </div>
  </div>

  <!-- Shared Item Details Modal (shop + collection) -->
  <div class="modal hidden" id="itemDetailModal">
    <div class="modalCard" id="itemDetailCard"></div>
  </div>


  <!-- Firebase boot + Auth wiring -->
  <script type="module">
    console.log("‚úÖ auth module loaded");

    import { callFn } from "./js/firebase.js";
    import { signup, login, logout, watchAuth } from "./js/auth.js";
    import { initRewardPopup } from "./js/rewards.js";

    const loginPanel = document.getElementById("loginPanel");
    const appRoot = document.getElementById("appRoot");
    const err = document.getElementById("authError");

    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const userEl  = document.getElementById("username");

    const rewardModal = document.getElementById("rewardModal");
    const rewardTitle = document.getElementById("rewardTitle");
    const rewardText  = document.getElementById("rewardText");
    const rewardClose = document.getElementById("rewardCloseBtn");

    function fireAuthChanged() {
      window.dispatchEvent(new Event("usa-auth-changed"));
      console.log("üîî usa-auth-changed fired. uid=", window.__USA_UID__);
    }

    // Simple "show modal once" protection (per page-load)
    let showingReward = false;

    function showRewardModal(title, html) {
      if (showingReward) return; // prevents double popup
      showingReward = true;

      if (rewardTitle) rewardTitle.textContent = title || "Rewards";
      rewardText.innerHTML = html || "";
      rewardModal.classList.remove("hidden");

      rewardClose.onclick = () => {
        rewardModal.classList.add("hidden");
        showingReward = false;
      };
    }

    document.getElementById("signupBtn").onclick = async () => {
      err.textContent = "";
      try {
        await signup(emailEl.value.trim(), passEl.value.trim(), userEl.value.trim());
      } catch (e) {
        console.error(e);
        err.textContent = e?.message || String(e);
      }
    };

    document.getElementById("loginBtn").onclick = async () => {
      err.textContent = "";
      try {
        await login(emailEl.value.trim(), passEl.value.trim());
      } catch (e) {
        console.error(e);
        err.textContent = e?.message || String(e);
      }
    };

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) logoutBtn.onclick = async () => {
      window.__USA_UID__ = null;
      fireAuthChanged();
      await logout();
    };

    // Results popup system (handled in rewards.js)
    initRewardPopup();

    // LocalStorage guard so daily bonus popup doesn't show twice in a day on refresh
    function nyDateKeyClient() {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/New_York",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      }).formatToParts(new Date());
      const y = parts.find(p => p.type === "year")?.value;
      const m = parts.find(p => p.type === "month")?.value;
      const d = parts.find(p => p.type === "day")?.value;
      return `${y}-${m}-${d}`;
    }

    const DAILY_POP_KEY = "usa_daily_bonus_popup_shown_";

    watchAuth(async (user) => {
      if (!user) {
        window.__USA_UID__ = null;
        fireAuthChanged();

        loginPanel.classList.remove("hidden");
        appRoot.classList.add("hidden");
        return;
      }

      window.__USA_UID__ = user.uid;
      fireAuthChanged();

      loginPanel.classList.add("hidden");
      appRoot.classList.remove("hidden");

      // ‚úÖ Server-side daily bonus
      try {
        const res = await callFn("ensureDailyBonus")({});
        const data = res?.data || res;

        console.log("üéÅ ensureDailyBonus:", data);

        const todayNY = data?.today || nyDateKeyClient();
        const key = DAILY_POP_KEY + todayNY;
        const alreadyShown = localStorage.getItem(key) === "1";

        if (data?.applied && !alreadyShown) {
          localStorage.setItem(key, "1");

          showRewardModal(
            "Daily Login Bonus!",
            `
              <div style="font-weight:900;">üéÅ Daily Bonus Claimed</div>
              <div style="margin-top:6px;">+<b>${data.bonus ?? 50}</b> Waffle Coins</div>
              <div style="margin-top:6px;">New Balance: <b>${data.coins ?? "?"}</b></div>
              <div style="opacity:.75;margin-top:8px;font-size:.9em;">(NY Date: ${todayNY})</div>
            `
          );
        }
      } catch (e) {
        console.warn("‚ùå ensureDailyBonus callable failed:", e);
      }
    });
  </script>

  <!-- App logic -->
  <script type="module" src="./js/app.js"></script>

</body>
</html>
