rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isMe(uid) { return signedIn() && request.auth.uid == uid; }

    // ----------------------------
    // USERS (profile + collection)
    // ----------------------------
    match /users/{uid} {
      // Needed for prediction leaderboard + HUD
      allow read: if signedIn();

      // Create profile doc on signup (client)
      allow create: if isMe(uid);

      // Client is ONLY allowed to change username
      allow update: if isMe(uid)
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(["username"]);

      allow delete: if false;

      // User inventory: user can read; ONLY Functions can write
      match /collection/{itemId} {
        allow read: if isMe(uid);
        allow write: if false;
      }
    }

    // ----------------------------
    // VOTING (client submits picks)
    // ----------------------------
    match /seasons/{seasonId}/gameDays/{date}/votes/{uid} {
      allow read: if isMe(uid);
      allow write: if isMe(uid); // locking + payouts enforced by Cloud Functions
    }

    // ----------------------------
    // REWARD POPUPS (function creates, user reads)
    // ----------------------------
    match /rewardPopups/{docId} {
      allow read: if signedIn() && resource.data.uid == request.auth.uid;
      allow write: if false;
    }

    // ----------------------------
    // ANNOUNCEMENTS (jackpots etc)
    // ----------------------------
    match /announcements/{id} {
      allow read: if signedIn();
      allow write: if false;
    }

    // ----------------------------
    // SHOP CATALOG (you edit in console)
    // ----------------------------
    match /shopItems/{id} {
      allow read: if signedIn();
      allow write: if false;
    }

    // Sale metadata (client reads, function writes)
    match /shopMeta/{id} {
      allow read: if signedIn();
      allow write: if false;
    }

    // ----------------------------
    // SUGGESTIONS (function-only)
    // ----------------------------
    match /suggestions/{id} {
      allow read: if false;
      allow write: if false;
    }

    // ----------------------------
    // DEFAULT DENY (everything else)
    // ----------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

